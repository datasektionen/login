# Login

Lives at `login.datasektionen.se`. Uses [CAS](https://en.wikipedia.org/wiki/Central_Authentication_Service) to talk with https://login.kth.se. Fetches user info from KTH ldap at ldap.kth.se:389.

## Environment variables to set for production:

```
SECRET_KEY # Used for flasks sessions. Should be securely random and very secret.
DATABASE_URL # A postgresql database url. Example: postgres://postgres:password@db:5432/
```

## Endpoints

### /hello

Returns `"Hello Login!"`. This endpoint is used for health-checks (a monitoring service checks that this endpoint returns a 200 status code).

### /login?callback=...

Must be called with parameter `callback` set to a url.

After the user has authenticated, the server will redirect to `callback` with the user's token appended at the end.

### /logout

Logs a user out.

### /verify/<token>?api_key=...

This is used to validate a user's token. Supply the token generated by `/login` in the path and a valid `api_key` and the server will answer with who the token belongs to. The response will be in JSON with the following format:

```json
{
    "first_name": "...",
    "last_name": "...",
    "user": "...",
    "emails": "...",
    "ugkthid": "..." # NOTE: on the form u1xxxxx
}
```

The API key should be generated from [pls](https://github.com/datasektionen/pls).

## Dev setup

First install [docker](https://docs.docker.com/get-docker/) and [docker-compose](https://docs.docker.com/compose/install/). Then run:

```sh
[sudo] docker-compose up
```

The webserver will be available at [http://localhost:8000](http://localhost:8000).

To access the db directly run:

```sh
[sudo] docker-compose exec db psql --username=postgres
```

To generate an `api_key` using `genkey.py` run:

```sh
[sudo] docker-compose exec web pipenv run python genkey.py <keyname>
```

These test users exist:

- juland
- tanlar
- gopgus

They all have the password: `rudolf`.
